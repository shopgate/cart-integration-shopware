dist: xenial
sudo: false
language: php

git:
  depth: false

before_script:
- phpenv config-rm xdebug.ini || return 0
- composer install

script:
- src/Backend/SgateShopgatePlugin/vendor/bin/phpunit

jobs:
  include:
  - stage: Dependency Checking + Unit Test + Code Style Fixing
    php: '7.0'
    script:
    - composer install
    - curl -L https://github.com/fabpot/local-php-security-checker/releases/download/v1.0.0/local-php-security-checker_1.0.0_linux_amd64 -o php-dependency-checker
    - chmod +x ./php-dependency-checker
    - ./php-dependency-checker
    - rm php-dependency-checker
    - curl -L http://files.shopgate.com/travis-ci/php-cs-fixer.phar -o php-cs-fixer
    - chmod a+x php-cs-fixer
    - ./php-cs-fixer fix --config=.php-cs.dist --cache-file=.php-cs.cache --diff --dry-run --verbose .
    - rm php-cs-fixer
    - src/Backend/SgateShopgatePlugin/vendor/bin/phpunit
  - stage: Unit Test
    php: '5.6'
  - stage: Unit Test
    php: '7.2'
  - stage: deploy
    php: '7.2'
    before_script: skip
    script:
    - if [[ "$TRAVIS_TAG" ]]; then ./release/build_release_package.sh ; fi
    deploy:
      provider: releases
      api_key:
        secure: "wlKLcNK/3AyC85NDGiDQhYjVDIrgpzvGkpVgC8Hybqd0GuWgKh4HYLO0BJ76CErGXG26YH1J3ITE+Q+Ez/NjXV13z9Q8ZOA3BbBPL4t8LT8P8pmUEAjoysPtDuEqMUe7WZXo6fxu+8b0pe4+TIevUgyCBPIqayHUVO3Fp3lgflmNrl70Rlf0AUq4UJ76XwhMMzhnBjElRmqQM6KQeEugahCryajXu3zRBPWsdlzbjnHLr2j4CS0QijL0JPao5cHKThgU0ggI5PEzJIFjg0CiLFRjPyfTK6C9T6uTOiDx1HNHzgy44+IbG1pJ60/4hgSAZy/yV3z2RV6yPxTUK/S8oo1oeFJTGqiewJrySm5HXzZRb+kh7C/4sg4sRiDRMCdpbpO13PJ70ANMmOXJkD/HqfIVpWumVM0lDMBQeYq6krxo1Bu+zcY1sK6SOH+umCjs25ytt45M80Qh/e5bs6um9kafSrcZCvSzrc4erSCkzySMdXI6pIBifkKIVIaQRnmwsKZSuVDEr9gqkrqJj53CdWBJF8w1cyy0VNU0NLt5fzAqGsOfK0GTh7Di5ChpvGNJIRECNulnlywXSVKPyu6SLtT/O5Fqaen+ihuIujh4m8/9A69m8SMNKu4Q0Xb2bqNeAP9KLlOInYAz2J0FzVjhlUu9jNatoNsMu9tK0DDguEs="
      file: shopgate-shopware-integration.zip
      skip_cleanup: true
      on:
        tags: true
cache:
  directories:
    - $HOME/.composer/cache/files

notifications:
  slack:
    rooms:
      - secure: "toDUhWLKPH/sxBsHcqKin3J5hVLVVDDhQ7Wfdcy77i5Ec7VelXq3RIZmqGCSwHb9FBzVQko7BHSoQbX06QSZSVzedWGXZExP8eGlYDv83VNbayCqPMQ40koaQC03Iae4NvQpDV9R5WcGwmck+nC4UehJTWadQBcGDl3BsrNS9tWaIyc0RpCO+kkQorhp+m66+SpGrmD/yBJ6p6HuGAnF9jEChNYp362D6ec0llpmbC1qHet0rqOVAVnBRhiO3pAiT9Pv321IcLaQGxUhlVyDInM8wLgllZ5d4rQcufpIclZwS94755qLmlD0mV010UQUS0z1rY7H3ybYPCgVovbojm6/vfXkzcAjHX4CRI/XkYhkqoJ3Ed0/aIq1aad82idjx81Nr+EN6h8OyMp6a4EASalBPBEusuLG/FTO656bmosxBHi7P9p1JRc3dB3D81EBK9V4tRCvegjk9O/nf2kaTGZ3k7HIX3IB6zVcPrRgi25MHDfWwjIpBy/pMDPYf8R45zXHwot5UtZPY11cC1KV9pGnOQApN742lgLzdXF4n3KQNzJ5Yl5qj40IIOw6eIUiAZNGXIhgs7SqCU476JZagjNC6SK97WK6soz/f+fbxmnEVLDf+ERGykp0l1P2BFfJ6iu1BgWMY9zqxKOVgFQrAZU5sjHf24wbiKm/MC5fCWk="
    on_success: change
    on_failure: always
